<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>All-in-on Model Based Custom Predictions for Alberta • allinone</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="All-in-on Model Based Custom Predictions for Alberta">
<meta property="og:description" content="Decision support tool
  that provides an interface to enable
  custom predictions based on estimates created by the Alberta
  Biodiversity Monitoring Institute (ABMI)
  in collaboration with the Boreal Avian Modelling (BAM) Project.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">allinone</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0-1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ABbiodiversity/allinone/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="allinone" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#allinone" class="anchor"></a>allinone</h1></div>
<blockquote>
<p>All-in-on model based custom predictions for species in Alberta</p>
</blockquote>
<div id="install" class="section level2">
<h2 class="hasAnchor">
<a href="#install" class="anchor"></a>Install</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://remotes.r-lib.org">"remotes"</a></span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span>
<span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"ABbiodiversity/allinone"</span><span class="op">)</span></code></pre></div>
<p>You will need data and coefficients from the <a href="https://github.com/ABbiodiversity/allinone-coefs">ABbiodiversity/allinone-coefs</a> repository. Clone or download the contents in zip format and extract into a folder (<code>dir</code> in the example).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dir</span> <span class="op">&lt;-</span> <span class="st">"~/repos/allinone-coefs"</span></code></pre></div>
<p>If you don’t need the spatial raster files from the ABbiodiversity/allinone-coefs, the <code>ai_doanload_coefs()</code> function will grab the coefficients for you and you’ll be ready to roll:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ABbiodiversity/allinone">allinone</a></span><span class="op">)</span>

<span class="co">#ai_dowload_coefs()</span>

<span class="fu"><a href="reference/coefs.html">ai_load_coefs</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">## [INFO] Loading coefs</span></code></pre></div>
</div>
<div id="command-line-usage" class="section level2">
<h2 class="hasAnchor">
<a href="#command-line-usage" class="anchor"></a>Command line usage</h2>
<p>See all the 1050 species that we have coefficients for:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/helper.html">ai_species</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">tab</span><span class="op">)</span>
<span class="co">## 'data.frame':    1050 obs. of  21 variables:</span>
<span class="co">##  $ SpeciesID     : chr  "Bryoria.fuscescens.glabra.lanestris.vrangiana" "Candelaria.pacifica" "Cetraria.aculeata.muricata" "Cetraria.arenaria" ...</span>
<span class="co">##  $ ScientificName: chr  "Bryoria fuscescens/glabra/lanestris/vrangiana" "Candelaria pacifica" "Cetraria aculeata/muricata" "Cetraria arenaria" ...</span>
<span class="co">##  $ TSNID         : chr  "99002220" "99002875" "98283083" "99002154" ...</span>
<span class="co">##  $ CommonName    : chr  NA NA NA NA ...</span>
<span class="co">##  $ ModelNorth    : logi  TRUE FALSE FALSE FALSE FALSE TRUE ...</span>
<span class="co">##  $ ModelSouth    : logi  TRUE TRUE TRUE TRUE TRUE TRUE ...</span>
<span class="co">##  $ UseavailNorth : logi  FALSE TRUE TRUE FALSE TRUE FALSE ...</span>
<span class="co">##  $ UseavailSouth : logi  FALSE FALSE FALSE FALSE FALSE FALSE ...</span>
<span class="co">##  $ Occurrences   : int  2719 213 151 58 75 1921 1968 2231 2055 402 ...</span>
<span class="co">##  $ nSites        : int  1028 148 73 28 58 846 1006 1008 887 197 ...</span>
<span class="co">##  $ SizeNorth     : logi  NA NA NA NA NA NA ...</span>
<span class="co">##  $ SizeSouth     : logi  NA NA NA NA NA NA ...</span>
<span class="co">##  $ Nonnative     : logi  FALSE FALSE FALSE FALSE FALSE FALSE ...</span>
<span class="co">##  $ LinkHabitat   : chr  "logit" "logit" "logit" "logit" ...</span>
<span class="co">##  $ LinkSpclim    : chr  "logit" "logit" "logit" "logit" ...</span>
<span class="co">##  $ AUCNorth      : num  0.926 0.808 NA NA 0.785 0.864 0.797 0.844 0.869 NA ...</span>
<span class="co">##  $ AUCSouth      : num  0.912 0.881 0.911 0.936 0.879 0.918 0.834 0.926 0.888 0.871 ...</span>
<span class="co">##  $ R2North       : num  0.494 0.15 NA NA 0.09 0.336 0.214 0.3 0.352 NA ...</span>
<span class="co">##  $ R2South       : num  0.356 0.236 0.327 0.359 0.188 0.306 0.213 0.4 0.221 0.297 ...</span>
<span class="co">##  $ Comments      : chr  NA NA NA NA ...</span>
<span class="co">##  $ Group         : chr  "lichens" "lichens" "lichens" "lichens" ...</span></code></pre></div>
<div id="predictor-data" class="section level3">
<h3 class="hasAnchor">
<a href="#predictor-data" class="anchor"></a>Predictor data</h3>
<p>We use an example data set that shows you how to organize the data:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## example data to see what is needed and how it is formatted</span>
<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata/example.RData"</span>, package<span class="op">=</span><span class="st">"allinone"</span><span class="op">)</span><span class="op">)</span>

<span class="co">## space climate data frame + veg/soil classes</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">spclim</span><span class="op">)</span>
<span class="co">## 'data.frame':    30 obs. of  26 variables:</span>
<span class="co">##  $ POINT_X             : num  -113 -111 -113 -113 -114 ...</span>
<span class="co">##  $ POINT_Y             : num  49.6 51.4 49.3 51.3 49.6 ...</span>
<span class="co">##  $ NSRNAME             : Factor w/ 21 levels "Alpine","Athabasca Plain",..: 13 6 13 8 13 13 6 6 6 8 ...</span>
<span class="co">##  $ NRNAME              : Factor w/ 6 levels "Boreal","Canadian Shield",..: 4 4 4 4 4 4 4 4 4 4 ...</span>
<span class="co">##  $ LUF_NAME            : Factor w/ 7 levels "Lower Athabasca",..: 5 4 5 5 5 4 5 4 5 5 ...</span>
<span class="co">##  $ AHM                 : num  37.6 40.6 34.1 33 27.1 36.1 46.4 42.2 38.7 28.6 ...</span>
<span class="co">##  $ PET                 : int  668 630 660 623 634 632 699 672 672 662 ...</span>
<span class="co">##  $ FFP                 : int  119 114 112 111 107 113 126 119 118 112 ...</span>
<span class="co">##  $ MAP                 : int  399 320 434 409 532 371 317 322 385 521 ...</span>
<span class="co">##  $ MAT                 : num  5 3 4.8 3.5 4.4 3.4 4.7 3.6 4.9 4.9 ...</span>
<span class="co">##  $ MCMT                : num  -9.4 -13.9 -8.7 -12 -8.4 -12.6 -12.3 -14.1 -9.7 -8.3 ...</span>
<span class="co">##  $ MWMT                : num  18 17.7 17.3 16.9 16.4 17.4 19.6 18.8 18.1 17.3 ...</span>
<span class="co">##  $ pAspen              : num  0.000202 0.21 0.001266 0.01 0.006599 ...</span>
<span class="co">##  $ pWater              : num  0.001382 0.014561 0.003223 0.000396 0.002973 ...</span>
<span class="co">##  $ pSoil               : num  0.999 0.985 0.997 1 0.997 ...</span>
<span class="co">##  $ wN                  : num  0 0 0 0 0 0 0 0 0 0 ...</span>
<span class="co">##  $ PeaceRiver          : num  0 0 0 0 0 0 0 0 0 0 ...</span>
<span class="co">##  $ NSR1CentralMixedwood: num  0 0 0 0 0 0 0 0 0 0 ...</span>
<span class="co">##  $ NSR1DryMixedwood    : num  0 0 0 0 0 0 0 0 0 0 ...</span>
<span class="co">##  $ NSR1Foothills       : num  0 0 0 0 0 0 0 0 0 0 ...</span>
<span class="co">##  $ NSR1Mountain        : num  0 0 0 0 0 0 0 0 0 0 ...</span>
<span class="co">##  $ NSR1North           : num  0 0 0 0 0 0 0 0 0 0 ...</span>
<span class="co">##  $ NSR1Parkland        : num  0 0 0 0 0 0 0 0 0 0 ...</span>
<span class="co">##  $ NSR1Shield          : num  0 0 0 0 0 0 0 0 0 0 ...</span>
<span class="co">##  $ veghf               : chr  "Crop" "RoughP" "Crop" "Crop" ...</span>
<span class="co">##  $ soilhf              : chr  "Crop" "RoughP" "Crop" "Crop" ...</span>

<span class="co">## veg+HF composition data matrix</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">p_veghf</span><span class="op">)</span>
<span class="co">##  [1] "Bare"           "RoughP"         "Crop"           "TameP"         </span>
<span class="co">##  [5] "Industrial"     "Mine"           "Rural"          "EnSoftLin"     </span>
<span class="co">##  [9] "HardLin"        "TrSoftLin"      "EnSeismic"      "Urban"         </span>
<span class="co">## [13] "Wellsites"      "Deciduous1"     "CCDeciduous1"   "CCDeciduous2"  </span>
<span class="co">## [17] "CCDeciduous3"   "CCDeciduous4"   "CCDeciduousR"   "Deciduous2"    </span>
<span class="co">## [21] "Deciduous3"     "Deciduous4"     "Deciduous5"     "Deciduous6"    </span>
<span class="co">## [25] "Deciduous7"     "Deciduous8"     "DeciduousR"     "GraminoidFen"  </span>
<span class="co">## [29] "GrassHerb"      "Marsh"          "Mixedwood1"     "CCMixedwood1"  </span>
<span class="co">## [33] "CCMixedwood2"   "CCMixedwood3"   "CCMixedwoodR"   "Mixedwood2"    </span>
<span class="co">## [37] "CCMixedwood4"   "Mixedwood3"     "Mixedwood4"     "Mixedwood5"    </span>
<span class="co">## [41] "Mixedwood6"     "Mixedwood7"     "Mixedwood8"     "MixedwoodR"    </span>
<span class="co">## [45] "Pine1"          "CCPine1"        "CCPine2"        "CCPine3"       </span>
<span class="co">## [49] "CCPine4"        "CCPineR"        "Pine2"          "Pine3"         </span>
<span class="co">## [53] "Pine4"          "Pine5"          "Pine6"          "Pine7"         </span>
<span class="co">## [57] "Pine8"          "PineR"          "Shrub"          "ShrubbyBog"    </span>
<span class="co">## [61] "ShrubbyFen"     "ShrubbySwamp"   "SnowIce"        "WhiteSpruce1"  </span>
<span class="co">## [65] "CCWhiteSpruce1" "CCWhiteSpruce2" "CCWhiteSpruce3" "CCWhiteSpruce4"</span>
<span class="co">## [69] "CCWhiteSpruceR" "WhiteSpruce2"   "WhiteSpruce3"   "WhiteSpruce4"  </span>
<span class="co">## [73] "WhiteSpruce5"   "WhiteSpruce6"   "WhiteSpruce7"   "WhiteSpruce8"  </span>
<span class="co">## [77] "WhiteSpruceR"   "TreedBog1"      "TreedBog2"      "TreedBog3"     </span>
<span class="co">## [81] "TreedBog4"      "TreedBog5"      "TreedBog6"      "TreedBog7"     </span>
<span class="co">## [85] "TreedBog8"      "TreedBogR"      "TreedFen1"      "TreedFen2"     </span>
<span class="co">## [89] "TreedFen3"      "TreedFen4"      "TreedFen5"      "TreedFen6"     </span>
<span class="co">## [93] "TreedFen7"      "TreedFen8"      "TreedFenR"      "TreedSwamp"</span>

<span class="co">## soil+HF composition data matrix</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">p_soilhf</span><span class="op">)</span>
<span class="co">##  [1] "RapidDrain" "Crop"       "RoughP"     "TameP"      "Industrial"</span>
<span class="co">##  [6] "Mine"       "Rural"      "EnSoftLin"  "HardLin"    "TrSoftLin" </span>
<span class="co">## [11] "EnSeismic"  "Wellsites"  "Blowout"    "Urban"      "ClaySub"   </span>
<span class="co">## [16] "Other"      "Loamy"      "SandyLoam"  "ThinBreak"</span></code></pre></div>
</div>
<div id="predict-for-a-species" class="section level3">
<h3 class="hasAnchor">
<a href="#predict-for-a-species" class="anchor"></a>Predict for a species</h3>
<p>You need to define the species ID (use the <code>tab</code> object to find out) and the bootstrap ID (<code>i</code>). The bootstrap ID can be between 1 and 100 (only 1 for mammals and habitat elements).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## define species and bootstrap id</span>
<span class="va">spp</span> <span class="op">&lt;-</span> <span class="st">"AlderFlycatcher"</span>
<span class="va">i</span> <span class="op">&lt;-</span> <span class="fl">1</span></code></pre></div>
<div id="composition-data" class="section level4">
<h4 class="hasAnchor">
<a href="#composition-data" class="anchor"></a>Composition data</h4>
<p>You can use composition data, i.e. giving the areas or proportions of different landcover types (columns) in a spatial unit (rows). The corresponding relative abundance values will be returned in a matrix format:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## use composition</span>
<span class="va">z1</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/preds.html">ai_predict</a></span><span class="op">(</span><span class="va">spp</span>, 
  spclim<span class="op">=</span><span class="va">spclim</span>, 
  veghf<span class="op">=</span><span class="va">p_veghf</span>, 
  soilhf<span class="op">=</span><span class="va">p_soilhf</span>,
  i<span class="op">=</span><span class="va">i</span><span class="op">)</span>
<span class="co">## [INFO] Making predictions for species AlderFlycatcher (birds)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">z1</span><span class="op">)</span>
<span class="co">## List of 2</span>
<span class="co">##  $ north: num [1:30, 1:96] 0 0 0 0 0 0 0 0 0 0 ...</span>
<span class="co">##   ..- attr(*, "dimnames")=List of 2</span>
<span class="co">##   .. ..$ : chr [1:30] "1167_502" "964_613" "1194_487" "973_442" ...</span>
<span class="co">##   .. ..$ : chr [1:96] "Bare" "RoughP" "Crop" "TameP" ...</span>
<span class="co">##  $ south: num [1:30, 1:19] 0.00 0.00 6.64e-07 0.00 1.41e-05 ...</span>
<span class="co">##   ..- attr(*, "dimnames")=List of 2</span>
<span class="co">##   .. ..$ : chr [1:30] "1167_502" "964_613" "1194_487" "973_442" ...</span>
<span class="co">##   .. ..$ : chr [1:19] "RapidDrain" "Crop" "RoughP" "TameP" ...</span></code></pre></div>
</div>
<div id="sector-effects" class="section level4">
<h4 class="hasAnchor">
<a href="#sector-effects" class="anchor"></a>Sector effects</h4>
<p>Having such a matrix format is ideal when further aggregation is to e performad on the output, e.g. when calculating sector effects. In the example we use only the current landscape here, and show how to use model weights (<code>wN</code>) to average the north and south results in the overlap zone:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## sector effects</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/psolymos/mefa4">mefa4</a></span><span class="op">)</span>
<span class="va">lt</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/helper.html">ai_classes</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">ltn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mefa4/man/nonDuplicated.html">nonDuplicated</a></span><span class="op">(</span><span class="va">lt</span><span class="op">$</span><span class="va">north</span>, <span class="va">Label</span>, <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">lts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mefa4/man/nonDuplicated.html">nonDuplicated</a></span><span class="op">(</span><span class="va">lt</span><span class="op">$</span><span class="va">south</span>, <span class="va">Label</span>, <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">Nn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mefa4/man/groupSums.html">groupSums</a></span><span class="op">(</span><span class="va">z1</span><span class="op">$</span><span class="va">north</span>, <span class="fl">2</span>, <span class="va">ltn</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">z1</span><span class="op">$</span><span class="va">north</span><span class="op">)</span>, <span class="st">"Sector"</span><span class="op">]</span><span class="op">)</span>
<span class="va">Ns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mefa4/man/groupSums.html">groupSums</a></span><span class="op">(</span><span class="va">z1</span><span class="op">$</span><span class="va">south</span>, <span class="fl">2</span>, <span class="va">lts</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">z1</span><span class="op">$</span><span class="va">south</span><span class="op">)</span>, <span class="st">"Sector"</span><span class="op">]</span><span class="op">)</span>
<span class="va">Ns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">Ns</span>, Forestry<span class="op">=</span><span class="fl">0</span><span class="op">)</span>
<span class="va">N</span> <span class="op">&lt;-</span> <span class="va">spclim</span><span class="op">$</span><span class="va">wN</span> <span class="op">*</span> <span class="va">Nn</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">spclim</span><span class="op">$</span><span class="va">wN</span><span class="op">)</span> <span class="op">*</span> <span class="va">Ns</span>
<span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">Nn</span><span class="op">)</span>
<span class="co">##         Native    Agriculture     RuralUrban         Energy Transportation </span>
<span class="co">##     0.64406824     0.14011059     0.01153628     0.03155056     0.02626116 </span>
<span class="co">##       Forestry </span>
<span class="co">##     0.17863231</span>
<span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">Ns</span><span class="op">)</span>
<span class="co">##         Native    Agriculture     RuralUrban         Energy Transportation </span>
<span class="co">##   2.973927e-03   1.180921e-02   2.369699e-04   2.922007e-10   3.790724e-10 </span>
<span class="co">##       Forestry </span>
<span class="co">##   0.000000e+00</span>
<span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>
<span class="co">##         Native    Agriculture     RuralUrban         Energy Transportation </span>
<span class="co">##    0.610374698    0.076370845    0.005830417    0.022772096    0.015636447 </span>
<span class="co">##       Forestry </span>
<span class="co">##    0.178632312</span></code></pre></div>
</div>
<div id="classified-landcover-data" class="section level4">
<h4 class="hasAnchor">
<a href="#classified-landcover-data" class="anchor"></a>Classified landcover data</h4>
<p>We have classified landcover data when we are making predictions for single polygons (which are aggregated in the composition data case). We can provide <code>veghf</code> and <code>soilhf</code> as a vector of these classes.</p>
<p>Make sure that the class names are consistent with column names in the example data matrices for the north and south, respectively.</p>
<p>The function now returns a list of vectors:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## use land cover classes</span>
<span class="va">z2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/preds.html">ai_predict</a></span><span class="op">(</span><span class="va">spp</span>, 
  spclim<span class="op">=</span><span class="va">spclim</span>, 
  veghf<span class="op">=</span><span class="va">spclim</span><span class="op">$</span><span class="va">veghf</span>, 
  soilhf<span class="op">=</span><span class="va">spclim</span><span class="op">$</span><span class="va">soilhf</span>,
  i<span class="op">=</span><span class="va">i</span><span class="op">)</span>
<span class="co">## [INFO] Making predictions for species AlderFlycatcher (birds)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">z2</span><span class="op">)</span>
<span class="co">## List of 2</span>
<span class="co">##  $ north: Named num [1:30] 0.00151 0.00835 0.00186 0.00443 0.0058 ...</span>
<span class="co">##   ..- attr(*, "names")= chr [1:30] "1" "2" "3" "4" ...</span>
<span class="co">##  $ south: Named num [1:30] 2.06e-05 6.72e-05 4.12e-05 1.07e-04 1.73e-04 ...</span>
<span class="co">##   ..- attr(*, "names")= chr [1:30] "1" "2" "3" "4" ...</span>

<span class="co">## averaging predictions</span>
<span class="va">avg2</span> <span class="op">&lt;-</span> <span class="va">spclim</span><span class="op">$</span><span class="va">wN</span> <span class="op">*</span> <span class="va">z2</span><span class="op">$</span><span class="va">north</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">spclim</span><span class="op">$</span><span class="va">wN</span><span class="op">)</span> <span class="op">*</span> <span class="va">z2</span><span class="op">$</span><span class="va">south</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">avg2</span><span class="op">)</span>
<span class="co">##  Named num [1:30] 2.06e-05 6.72e-05 4.12e-05 1.07e-04 1.73e-04 ...</span>
<span class="co">##  - attr(*, "names")= chr [1:30] "1" "2" "3" "4" ...</span></code></pre></div>
</div>
</div>
<div id="predict-for-multiple-species" class="section level3">
<h3 class="hasAnchor">
<a href="#predict-for-multiple-species" class="anchor"></a>Predict for multiple species</h3>
<p>Once the predictors are organized, loop over the species IDs from <code>tab</code> and store the results in an organized fashion.</p>
</div>
</div>
<div id="spatial-data-manipulation" class="section level2">
<h2 class="hasAnchor">
<a href="#spatial-data-manipulation" class="anchor"></a>Spatial data manipulation</h2>
<p>The variables in the <code>spclim</code> object can be extracted from the raster layers stored in the <a href="https://github.com/ABbiodiversity/allinone-coefs">ABbiodiversity/allinone-coefs</a> repository. Clone or download the contents in zip format and extract into a folder (<code>dir</code> variable used here).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span><span class="op">)</span>

<span class="co">## you got some coordinates (degree long/lat)</span>
<span class="va">XY</span> <span class="op">&lt;-</span> <span class="va">spclim</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"POINT_X"</span>, <span class="st">"POINT_Y"</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/headtail.html">head</a></span><span class="op">(</span><span class="va">XY</span><span class="op">)</span>

<span class="co">## make a sf data frame</span>
<span class="va">xy</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">XY</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"POINT_X"</span>, <span class="st">"POINT_Y"</span><span class="op">)</span><span class="op">)</span>
<span class="co">## set CRS</span>
<span class="va">xy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_set_crs</a></span><span class="op">(</span><span class="va">xy</span>, <span class="st">"+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"</span><span class="op">)</span>

<span class="co">## variable names</span>
<span class="va">vn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"AHM"</span>, <span class="st">"FFP"</span>, <span class="st">"MAP"</span>, <span class="st">"MAT"</span>, <span class="st">"MCMT"</span>, <span class="st">"MWMT"</span>, 
  <span class="st">"NSR1CentralMixedwood"</span>, <span class="st">"NSR1DryMixedwood"</span>, <span class="st">"NSR1Foothills"</span>, 
  <span class="st">"NSR1Mountain"</span>, <span class="st">"NSR1North"</span>, <span class="st">"NSR1Parkland"</span>, <span class="st">"NSR1Shield"</span>, 
  <span class="st">"pAspen"</span>, <span class="st">"PeaceRiver"</span>, <span class="st">"PET"</span>, <span class="st">"pWater"</span>, <span class="st">"wN"</span><span class="op">)</span>
<span class="co">## link to the rasters &amp; create a stack</span>
<span class="va">rl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="va">vn</span><span class="op">)</span>
  <span class="va">rl</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">dir</span>, <span class="st">"spatial"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">j</span>, <span class="st">".tif"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">rl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="va">rl</span><span class="op">)</span>

<span class="co">## transform xy to Alberta TM</span>
<span class="va">xy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">xy</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/projection.html">proj4string</a></span><span class="op">(</span><span class="va">rl</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">rl</span><span class="op">[[</span><span class="st">"pAspen"</span><span class="op">]</span><span class="op">]</span>, axes<span class="op">=</span><span class="cn">FALSE</span>, box<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">xy</span><span class="op">$</span><span class="va">geometry</span>, add<span class="op">=</span><span class="cn">TRUE</span>, pch<span class="op">=</span><span class="fl">3</span><span class="op">)</span>

<span class="co">## extract info</span>
<span class="va">e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/extract.html">extract</a></span><span class="op">(</span><span class="va">rl</span>, <span class="va">xy</span><span class="op">)</span>

<span class="co">## absolute difference should be tiny</span>
<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/rowSums.html">colSums</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">spclim</span><span class="op">[</span>,<span class="va">vn</span><span class="op">]</span> <span class="op">-</span> <span class="va">e</span><span class="op">[</span>,<span class="va">vn</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co">## we need long/lat as in XY too</span>
<span class="va">spclim2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">XY</span>, <span class="va">e</span><span class="op">)</span>

<span class="co">## let's see what we get</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="fu"><a href="reference/preds.html">ai_predict</a></span><span class="op">(</span><span class="va">spp</span>, 
  spclim<span class="op">=</span><span class="va">spclim2</span>, 
  veghf<span class="op">=</span><span class="va">spclim</span><span class="op">$</span><span class="va">veghf</span>, 
  soilhf<span class="op">=</span><span class="va">spclim</span><span class="op">$</span><span class="va">soilhf</span>,
  i<span class="op">=</span><span class="va">i</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="batch-processing" class="section level2">
<h2 class="hasAnchor">
<a href="#batch-processing" class="anchor"></a>Batch processing</h2>
<p>For batch processing, look into the <code>inst/docker</code> folder. The API can be deployed using Docker or Docker Compose.</p>
<div id="request" class="section level3">
<h3 class="hasAnchor">
<a href="#request" class="anchor"></a>Request</h3>
<p>Pass is a JSON object (Content type: application/json) as the request body with longitude, latitude, veg/soil/HF classes, the species ID and the bootstrap ID (all these arrays in side an object).</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"long"</span><span class="fu">:</span><span class="ot">[</span><span class="fl">-112.6178</span><span class="ot">,</span><span class="fl">-110.9309</span><span class="ot">,</span><span class="fl">-112.8359</span><span class="ot">,</span><span class="fl">-113.3896</span><span class="ot">,</span><span class="fl">-113.8632</span><span class="ot">,</span><span class="fl">-112.299</span><span class="ot">,</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="fl">-110.5805</span><span class="ot">,</span><span class="fl">-111.7806</span><span class="ot">,</span><span class="fl">-112.3541</span><span class="ot">,</span><span class="fl">-113.4144</span><span class="ot">,</span><span class="fl">-110.2329</span><span class="ot">,</span><span class="fl">-114.6634</span><span class="ot">,</span><span class="fl">-111.5857</span><span class="ot">,</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="fl">-114.2688</span><span class="ot">,</span><span class="fl">-114.4383</span><span class="ot">,</span><span class="fl">-110.4444</span><span class="ot">,</span><span class="fl">-113.6355</span><span class="ot">,</span><span class="fl">-113.5874</span><span class="ot">,</span><span class="fl">-113.7964</span><span class="ot">,</span><span class="fl">-113.9445</span><span class="ot">,</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="fl">-119.9851</span><span class="ot">,</span><span class="fl">-112.7504</span><span class="ot">,</span><span class="fl">-113.5144</span><span class="ot">,</span><span class="fl">-112.7433</span><span class="ot">,</span><span class="fl">-118.0259</span><span class="ot">,</span><span class="fl">-116.2997</span><span class="ot">,</span><span class="fl">-114.9535</span><span class="ot">,</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="fl">-111.387</span><span class="ot">,</span><span class="fl">-111.8138</span><span class="ot">,</span><span class="fl">-111.1588</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"lat"</span><span class="fu">:</span><span class="ot">[</span><span class="fl">49.5851</span><span class="ot">,</span><span class="fl">51.3653</span><span class="ot">,</span><span class="fl">49.3464</span><span class="ot">,</span><span class="fl">51.344</span><span class="ot">,</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="fl">49.5951</span><span class="ot">,</span><span class="fl">51.3239</span><span class="ot">,</span><span class="fl">50.2184</span><span class="ot">,</span><span class="fl">50.9328</span><span class="ot">,</span><span class="fl">49.5974</span><span class="ot">,</span><span class="fl">49.3468</span><span class="ot">,</span><span class="fl">53.4814</span><span class="ot">,</span><span class="fl">53.8818</span><span class="ot">,</span><span class="fl">53.1679</span><span class="ot">,</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="fl">51.1549</span><span class="ot">,</span><span class="fl">51.3357</span><span class="ot">,</span><span class="fl">52.3465</span><span class="ot">,</span><span class="fl">51.7699</span><span class="ot">,</span><span class="fl">53.748</span><span class="ot">,</span><span class="fl">52.7971</span><span class="ot">,</span><span class="fl">52.1959</span><span class="ot">,</span><span class="fl">59.2693</span><span class="ot">,</span><span class="fl">56.3071</span><span class="ot">,</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="fl">58.269</span><span class="ot">,</span><span class="fl">56.1541</span><span class="ot">,</span><span class="fl">56.3535</span><span class="ot">,</span><span class="fl">59.8075</span><span class="ot">,</span><span class="fl">53.046</span><span class="ot">,</span><span class="fl">58.2175</span><span class="ot">,</span><span class="fl">58.7773</span><span class="ot">,</span><span class="fl">55.0714</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"veghf"</span><span class="fu">:</span><span class="ot">[</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"RoughP"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"TameP"</span><span class="ot">,</span><span class="st">"GrassHerb"</span><span class="ot">,</span><span class="st">"GrassHerb"</span><span class="ot">,</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"GrassHerb"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"Rural"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"TameP"</span><span class="ot">,</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Crop"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"TreedFenR"</span><span class="ot">,</span><span class="st">"TreedBog4"</span><span class="ot">,</span><span class="st">"TreedSwamp"</span><span class="ot">,</span><span class="st">"TreedBog5"</span><span class="ot">,</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CCDeciduousR"</span><span class="ot">,</span><span class="st">"TreedFen8"</span><span class="ot">,</span><span class="st">"CCDeciduous2"</span><span class="ot">,</span><span class="st">"PineR"</span><span class="ot">,</span><span class="st">"ShrubbyFen"</span><span class="ot">,</span><span class="st">"Mixedwood2"</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"soilhf"</span><span class="fu">:</span><span class="ot">[</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"RoughP"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"TameP"</span><span class="ot">,</span><span class="st">"Blowout"</span><span class="ot">,</span><span class="st">"ThinBreak"</span><span class="ot">,</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RapidDrain"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"Rural"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TameP"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"Crop"</span><span class="ot">,</span><span class="st">"RapidDrain"</span><span class="ot">,</span><span class="st">"RapidDrain"</span><span class="ot">,</span><span class="st">"RapidDrain"</span><span class="ot">,</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RapidDrain"</span><span class="ot">,</span><span class="st">"RapidDrain"</span><span class="ot">,</span><span class="st">"RapidDrain"</span><span class="ot">,</span><span class="st">"RoughP"</span><span class="ot">,</span><span class="st">"RapidDrain"</span><span class="ot">,</span><span class="st">"RapidDrain"</span><span class="ot">,</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RapidDrain"</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"spp"</span><span class="fu">:</span><span class="ot">[</span><span class="st">"AlderFlycatcher"</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"i"</span><span class="fu">:</span><span class="ot">[</span><span class="dv">1</span><span class="ot">]</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
</div>
<div id="response" class="section level3">
<h3 class="hasAnchor">
<a href="#response" class="anchor"></a>Response</h3>
<p>The response is a JSON (application/json) array with the model averaged relative abundance values:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ot">[</span><span class="dv">0</span><span class="ot">,</span><span class="fl">0.0001</span><span class="ot">,</span><span class="dv">0</span><span class="ot">,</span><span class="fl">0.0001</span><span class="ot">,</span><span class="fl">0.0002</span><span class="ot">,</span><span class="dv">0</span><span class="ot">,</span><span class="dv">0</span><span class="ot">,</span><span class="dv">0</span><span class="ot">,</span><span class="dv">0</span><span class="ot">,</span><span class="fl">0.0001</span><span class="ot">,</span><span class="fl">0.0044</span><span class="ot">,</span><span class="fl">0.0105</span><span class="ot">,</span><span class="fl">0.0063</span><span class="ot">,</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fl">0.0045</span><span class="ot">,</span><span class="fl">0.005</span><span class="ot">,</span><span class="fl">0.0055</span><span class="ot">,</span><span class="fl">0.0059</span><span class="ot">,</span><span class="fl">0.0128</span><span class="ot">,</span><span class="fl">0.0116</span><span class="ot">,</span><span class="fl">0.0082</span><span class="ot">,</span><span class="fl">0.1826</span><span class="ot">,</span><span class="fl">0.0326</span><span class="ot">,</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fl">0.072</span><span class="ot">,</span><span class="fl">0.0269</span><span class="ot">,</span><span class="fl">0.3291</span><span class="ot">,</span><span class="fl">0.0538</span><span class="ot">,</span><span class="fl">0.1034</span><span class="ot">,</span><span class="fl">0.0447</span><span class="ot">,</span><span class="fl">0.1266</span><span class="ot">,</span><span class="fl">0.0681</span><span class="ot">]</span></span></code></pre></div>
</div>
<div id="docker-workflow" class="section level3">
<h3 class="hasAnchor">
<a href="#docker-workflow" class="anchor"></a>Docker workflow</h3>
<p>A Docker workflow is ideal because the size of the application with all the required spatial layers and coefficients is relatively small.</p>
<div id="building-the-image" class="section level4">
<h4 class="hasAnchor">
<a href="#building-the-image" class="anchor"></a>Building the image</h4>
<p>Change directory to where the Dockerfile is, build and push the image:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> inst/docker</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">REGISTRY</span><span class="op">=</span><span class="st">"psolymos"</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">TAG</span><span class="op">=</span><span class="st">"allinone:latest"</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">## build the image</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-t</span> <span class="va">$REGISTRY</span>/<span class="va">$TAG</span> .</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> push <span class="va">$REGISTRY</span>/<span class="va">$TAG</span></span></code></pre></div>
</div>
<div id="deploying" class="section level4">
<h4 class="hasAnchor">
<a href="#deploying" class="anchor"></a>Deploying</h4>
<p>The Docker image can be deployed enywhere. The machine needs to have the Docker Engine installed. Pull the Docker image to the machine you want to run the API on:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> pull <span class="va">$REGISTRY</span>/<span class="va">$TAG</span></span></code></pre></div>
<p>In production, run the image with port mapping (-p host:container) in the background (-d):</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-d</span> <span class="at">--name</span> aiapi <span class="at">-p</span> 8080:8080 <span class="va">$REGISTRY</span>/<span class="va">$TAG</span></span></code></pre></div>
<p>Now use curl to make a request and test the API:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">## curl</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> http://localhost:8080/ <span class="at">-d</span> <span class="dt">\</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">'{"long":[-112.6178,-111.1588],"lat":[49.5851,55.0714],"veghf":["Crop","Mixedwood2"],"soilhf":["Crop","RapidDrain"],"spp":["AlderFlycatcher"],"i":[1]}'</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">## this is the response</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># [0,0.0681]</span></span></code></pre></div>
<p>See the logs:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> logs aiapi</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># [INFO] This is the All-in-one API</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># [INFO] Packages loaded</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># [INFO] Raster stack loaded</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># [INFO] Loading coefs</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># [INFO] 2021-07-24 06:36:14 Starting server: http://0.0.0.0:8080</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># [INFO] Making predictions for species AlderFlycatcher (birds) i=1</span></span></code></pre></div>
<p>Kill and remove the container:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> kill aiapi <span class="kw">&amp;&amp;</span> <span class="ex">docker</span> rm aiapi</span></code></pre></div>
<p>It is advised to add the Docker background process to systemd or use Docker Compose in production. Docker Compose can better handle container restarts and can run multiple replicas (simple round robin load balancing, which requires a proxy server, like Nginx or Caddy).</p>
<p>See the <code>inst/docker/docker-compose.yml</code> file for details. Deploy with <code>docker-compose up -d</code> which will publish the app on port 8080.</p>
<p>When the containers are already running, and the configuration or images have changed after the container’s creation, <code>docker-compose up</code> picks up the changes. Tear down with <code>docker-compose down</code>.</p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Browse source code at <br><a href="https://github.com/ABbiodiversity/allinone/">https://​github.com/​ABbiodiversity/​allinone/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/ABbiodiversity/allinone/issues">https://​github.com/​ABbiodiversity/​allinone/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li>
<a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a>
</li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Peter Solymos <br><small class="roles"> Maintainer </small>  </li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p>Developed by Peter Solymos.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
